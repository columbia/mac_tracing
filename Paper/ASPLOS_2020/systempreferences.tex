System Preferences provides a central location in macOS to customize
system settings, inclduing configuring additional monitors. A tool called
\vv{DisableMonitor}~\cite{disablemonitor} completes its function with
enable/disable monitors online. We blocked on the spinning cursor while
disabling an external monitor and rearranging windows in \vv{Display} panel.

The log collected with \xxx contains 1) baseline scenario where the displays
are re-arranged with the enabled external monitor, and 2) spinning scenario in
which we disable the external monitor with \vv{DisableMonitor} and re-arrange
the displays. The \spinningnode in the main thread is dominated by system
calls, \vv{mach\_msg} and \vv{thread\_switch}, which falls into the category of
\textbf{Repeated Yield}. We discovered two missing data flags with \vv{lldb},
``\vv{\_gCGWillReconfigureSeen}'' and ``\vv{\_gCGDidReconfigureSeen}'', which
signify the status of configuring and break the loop of thead yielding. \xxx
learns from the baseline scenario that the main thread is responsible to set
both of them after receiving specific datagrams from WindowServer. Conversly,
setting of ``\vv{\_gCGDidReconfigureSeen}'' is missing in the spining case,
where the main thread yields repeatedly to send messages to WindowServer for
such datagram.

In conclusion, we discovered that the bug is inherent in the design of the
CoreGraphics library, and would have to fixed by Apple. We verified this
diagnosis by creating a dynamic binary patch with lldb to fix the deadlock. The
patched library makes DisableMonitor work correctly, while preserving correct
behavior for other applications.

%%Given the information, we launched the interactive debugging by feeding
%%the debugging script with those APIs mentioned above. We set the
%%method \textit{activeDisplayNotificationHandler} as a breakpoint
%%where the script begins debugging. \textit{displayReconfigured} and
%%\textit{CGSSnarfAndDispatchDatagrams} are used to indicate the end of debugging
%%for the normal case and spinning case respectively. By diffing the two logs,
%%we notice the different branches in \textit{display\_notify\_proc} called by
%%\textit{activeDisplayNotificationHandler}. 
