\section{Case Studies}\label{sec:casestudy}

In this section, we demonstrate how \xxx helps to diagnose \nbug spinning-cursor
cases in \napps popular applications. Table~\ref{table:bugs-desc} describes
these spinning-cursor cases.

We studied how WindowsServer and NSEvent thread per application coordinate to
determine when a spinning cursor needs to be displayed because it is fundamental
in understanding all spinning-cursor cases yet not straightforward. Two data
flags ``\vv{is\_mainthread\_spinning}'' and ``\vv{dispatch\_to\_mainthread}''
are involved. We refer to this case XXXBug-ID.

%TableXXX describes these spinning-cursor cases.
%Should have a table for issue description
%Bug ID |  Application  |  Bug Description
\begin{table}[ht]
\footnotesize
\centering
  \begin{tabularx}{\columnwidth}{l|c|c}
    \hline
    \textbf{Bug ID} & \textbf{Application} & \textbf{Bug description}\\
    \hline
	 0 & WindowServer & display spinning cursor\\
    \hline
	 1 & \begin{tabular}{@{}c@{}} 
	 System Preferences\\
	 %:system settings\\
	 %customization app.
	 \end{tabular}
	 & \begin{tabular}{@{}c@{}}
	 Disabling an online\\
	 external monitor and\\
	 rearranging windows\\
	 cause the freeze.
	 \end{tabular}
	 \\
     \hline
	 2 & \begin{tabular}{@{}c@{}} 
	 Sequel Pro
	 \end{tabular}
	 & \begin{tabular}{@{}c@{}}
	 Lost connection freezes\\
	 the whole application.
	 \end{tabular}
	 \\
     \hline
	 3 & \begin{tabular}{@{}c@{}} 
	 TeXStudio
	 %: LaTeX editor
	 \end{tabular}
	 & \begin{tabular}{@{}c@{}}
	 Modification on bib file\\
	 from vim causes the main\\
	 window spinning.
	 \end{tabular}
	 \\
     \hline
	 4 & \begin{tabular}{@{}c@{}} 
	 Installer
	 \end{tabular}
	 & \begin{tabular}{@{}c@{}}
	 Move cursor out of the\\
	 authentication window \\
	 causes spinning.
	 \end{tabular}
	 \\
     \hline
	 5 & \begin{tabular}{@{}c@{}} 
	 Notes\\
	 %note-taking \\
	 %app from Apple 
	 \end{tabular}
	 & \begin{tabular}{@{}c@{}}
	 launching Notes with \\
	 a saved relatively\\
	 long note.\\
	 \end{tabular}
	 \\
     \hline
	 6 & \begin{tabular}{@{}c@{}}
	 TextEdit
	 %:rich text\\
	 %editing app from Apple
	 \end{tabular}
	 & \begin{tabular}{@{}c@{}}
	 Select, copy, paste\\%delete, insert and save
	 on text over 30M\\
	 cause freeze.
	 \end{tabular}
	 \\
     \hline
	 7 & \begin{tabular}{@{}c@{}}
	 Microsoft Words
	 \end{tabular}
	 & \begin{tabular}{@{}c@{}}
	 copy and paste on\\
	 document over 400\\
	 pages cause hang.
	 \end{tabular}
	 \\
     \hline
	 8 & Sublime Text
	 & \begin{tabular}{@{}c@{}}
	 Copy and paste in file\\
	 over 49000 lines.
	 \end{tabular}
	\\
    \hline
	 9 & TextMate 
	 & \begin{tabular}{@{}c@{}}
	 Paste text over 4000\\
	 lines causes spinning.
	 \end{tabular}
	\\
    \hline
	 10 & CotEditor
	 & \begin{tabular}{@{}c@{}}
	 Paste in file over 4000\\
	 lines causes spinning.
	 \end{tabular}
	\\
	 \hline
  \end{tabularx}
  \caption{Bug Descriptions}
  \label{table:bugs-desc}
\end{table}


%Start a new paragraph
%"TableXXX shows the results.  [Here we should show the big table, and talk about the high-level bits.]"

We compared \xxx with traditional causual tracing methods~\cite{XXXX} on edges
and vertices \xxx mitigated. and studied the ratios of over-connection vertices
avoided with message peers hueristically, and the under-connection edgs added by
both data flags and wait event inside a block. User interactions are critical in
the path slicing due to the inherent incorrect in the graph. Our results shows
the user interaction does not overwhelm the debugging process while it makes
the debugging much more efficient. Table~\ref{table:results} demonstrates our
results with the length of path sliced with \xxx, which is much shorter than the
one generated automatically by heuristically choosing the most recent edges when
multiple predecessors.


\begin{table*}[ht]
\footnotesize
\centering
  \begin{tabularx}{\textwidth}{l|cccccc}
 	   & rate of vertices   & rate of edgs&           & length of \xxx      & length of auto      & \# of\\
       & filted by          & by          & \# of     & baseline/spinning   & baseline/spinning   &user\\
Bug ID & batchprocessing    & data flag   & data flag & path slicing        & path slicing        &interaction \\
\hline
\hline
 1-SystemPreferences&&&&&&\\
 2-SequelPro & \% & \% & 3 & 5 &  & 2  \\
 3-TeXStudio & \% & \% & 3 & 6 &  & 3 \\
 4-Installer &&&&&& \\
 5-Notes &&&&&& \\
 6-TextEdit(copy)&\% &\% & 3 & 21 & & 5\\
 7-MSWord(copy)&\%&\%& 3 &67& & 22\\
 8-SublimeText(copy)&\%&\%&3 & 3 & & 1\\
 9-TextMate(paste) & \%&\% &3 & 23& & 0\\
 10-CotEditor(paste) & \%& \%& 3 & 4 & & 1\\
\hline
  \end{tabularx}
  \caption{Graph Comparison}
  \label{table:results}
\end{table*}

%Last paragraph:
In the remaining of this section, we present the case studies by category in (\S\ref{XXX}). 

\subsection{Long Running}

In this section, we discuss the cases where the \spinningnode is busy on the
CPU. Most of the text editing apps fall into this bug category. We studied
TeXstudio, TextEdit, Microsoft Word, Sublime Text, Text Mate and CotEditor to
reveal their root causes.

\paragraph{TeXStudio}
\input{texstudio}

\paragraph{Other Editing Apps}

Select, copy, paste, delete, insert and save are common operations for text
editing. However, these operations on a large acontext usually trigger spinning
cursors. Depending on their implementations, CotEditor and TextMate successfully
avoid hangs on copy and selection operation. \xxx can helps the developer to
figure out the more efficient way to fulfill editing operations. We briefly list
the reports from \spinningnode and corresponding user input event from the path
slicing in Table~\ref{table:texteditapps}. The path usually involves several
daemons, Figure~\ref{fig:diagramXXX} illustrates the spinning case of XXX to
represent cases in this category.

\paragraph{7-MSWord}

In bug 7-MSWord, the length of path interactively sliced from the \spinningnode
is 67, while the automatically slicing generates a path of 136 vertices. We
compared the path and find out the difference exists in the choosing of the
predecessor for the third vertex in paths.

In the vertex, user can learned from the callstack that Microsoft Word launches
a service NSServiceControllerCopyServiceDictionarie after woken by another
thread of itself. The thread continues to send message to \vv{launchd} to add
service and get a reply message there. With the most recent heuristics in
automatically slicing, \xxx choose \vv{launchd} as its precedessor, while the
user can identify that the execution segment is working for the request from the
thread of itself.

\begin{table}[H]
\footnotesize
\centering
  \begin{tabularx}{\columnwidth}{l|l|l}
                  &                     &\\%&\textbf{root cause}\\%& \textbf{involved daemons}\\
  \textbf{BUG-ID} & \textbf{costly API} &UI\\%&\textbf{UI}\\%& \textbf{involved daemons}\\
  \hline
  \hline
  5-Notes         & \begin{tabular}{@{}l@{}}
  					\vv{1)NSDetectScrollDevices}\\
					\vv{\xspace ThenInvokeOnMainQueue}\\
					\end{tabular}
				  &-
				  \\
  \hline
  6-TexEdit       & \begin{tabular}{@{}l@{}}
  					\vv{1)[NSTextView(NSPasteboard) \_write}\\
					\vv{\xspace RTFDInRanges:toPasteboard:]}\\
					\vv{2)get\_vImage\_converter}\\
  					\vv{3)get\_full\_conversion\_code\_fragment}\\
					\end{tabular}
				  & \vv{key c}
				  \\
  \hline
  7-MSWord        & \begin{tabular}{@{}l@{}}
					\vv{1)-[NSPasteboard setData:}\\
					\vv{\xspace forType:index:usesPboardTypes:]}\\
 					\vv{2)\_CFStringCreateImmutableFunnel3}\\
  					\vv{3)platform\_memmove}\\
					\vv{4)lseek}, \vv{5)fstat64}, \vv{6)fcntl}\\
					\end{tabular}
				  & \vv{key c}
				  \\
  \hline

  8-SublimeText   & \begin{tabular}{@{}l@{}} 
					\vv{1)px\_copy\_to\_clipboard}\\
  					\vv{2)\_\_CFToUTF8Len}\\
  					\end{tabular}
				  & \vv{key c}
				  \\
  \hline
  9-TextMate      & \begin{tabular}{@{}l@{}}
  					\vv{1)-[OakTextView paste:]}\\
					\vv{2)CFAttributedStringSet}\\
					\vv{3)TASCIIEncoder::Encode}\\
  					\end{tabular}
				  & \vv{key v}
				  \\
  \hline

  10-CotEditor    & \begin{tabular}{@{}l@{}}
  					\vv{1)CFStorageGetValueAtIndex}\\
					\vv{2)-[NSBigMutableString}\\
					\vv{\xspace characterAtIndex:]}\\
  					\end{tabular}
				  & \vv{key v}
				  \\
  \hline
  \end{tabularx}
  \caption{Root cause of spinning cursor in editing Apps}
  \label{table:texteditapps}
\end{table}


%\begin{itemize}
%  \item \textbf{Notes}:
%	  While launching the Notes, it is busy with
%	  \vv{NSDetectScrollDevicesThenInvokeOnMainQueue}.
%
%  \item \textbf{TextEdit}:
%	  \xxx reports CPU busy on the storage of characters \vv{[NSBigMutableString\
%	  getCharacters:range:]} and \vv{NSFastFillAllGlyphHolesForCharacterRange} for
%	  selection.
%
%	  When copy spins, \xxx reports
%	  \vv{get\_vImage\_converter} and \vv{get\_full\_conversion\_code\_fragment}
%	  occupy the main thread to finish \vv{[NSTextView(NSPasteboard)\
%	  \_writeRTFDInRanges:toPasteboard:]}.
%	  
%	  Paste operation causes the main thread overwhelmed by \vv{\_RTFGetToken}
%	  and \vv{platform\_memmove}. Both of them are called by the handler
%	  \vv{-[NSTextView(NSPasteboard)\ \_readSelectionFromPasteboard:types:]}
%
%  \item \textbf{Microsoft Words}:
%	  Both copy and paste in Microsoft Words are overwhelmed by system calls
%	  \vv{lseek}, \vv{fstat64}, \vv{fcntl} on the same file descriptor.
%	  In copy operation, \vv{\_\_CFStringCreateImmutableFunnel3} and
%	  \vv{platform\_memmove} are invoked for \vv{-[NSPasteboard\
%	  \_setData:forType:index:usesPboardTypes:]}, while the paste operation is
%	  dominated by \vv{platform\_memmove} and \vv{}.
%
%  \item \textbf{Sublime Text}:
%	  Copy in SublimeText is busy encoding characters with \vv{\_\_CFToUTF8Len They}
%	  are called from handler \vv{px\_copy\_to\_clipboard}.
%
%	  Paste is dominated by \vv{decode\_utf8}, \vv{convert\_utf8\_to\_utf32}, string
%	  \vv{append} and \vv{platform\_memmove} from \vv{px\_copy\_from\_clipboard}.
%
%	  Delete on Sublime Text causes its main thread is busy processing
%	  \vv{TokenStorage::substr}.
%
%  \item \textbf{TextMate}:
%	  TextMate only spins on the paste operation in our experiments, the main
%	  thread is busy with \vv{-[OakTextView paste:]} which iterates through
%	  paragraphs, fetches characters and processed with \vv{CFAttributedStringSet} and
%	  \vv{TASCIIEncoder::Encode}.
%
%  \item \textbf{CotEditor}:
%	  Similar to TextMate, CotEditor does not spinning on copy. In paste and hitting
%	  a return key cause the main thread busy on processing \vv{-[NSBigMutableString
%	  characterAtIndex:]} and \vv{CFStorageGetValueAtIndex} in the call stacks.
%\end{itemize}

\subsection{Repeated Yield and Long Wait}
In this section, we discuss the cases where the \spinningnode is blocking on
wait event or yielding loop, correponding to \textbf{Long Wait} and \textbf{Repeated Yield}.
\paragraph{SequelPro}
\input{sequelpro}
\paragraph{Installer}
\input{installer}
\paragraph{SystemPreferences}
\input{systempreferences}
